
{% extends "admin/_base.html" %}
{% block admin_content %}

{# Quick stats #}
<div class="grid cards" style="margin-bottom:20px;">
  <article class="card">
    <div class="card__body">
      <p class="muted small">Total logs</p>
      <p style="font-size:22px;font-weight:800;">{{ total_logs | default(0) }}</p>
    </div>
  </article>
  <article class="card">
    <div class="card__body">
      <p class="muted small">Today</p>
      <p style="font-size:22px;font-weight:800;">{{ today_logs | default(0) }}</p>
    </div>
  </article>
  <article class="card">
    <div class="card__body">
      <p class="muted small">Warnings</p>
      <p style="font-size:22px;font-weight:800;color:#d97706;">{{ warning_count | default(0) }}</p>
    </div>
  </article>
  <article class="card">
    <div class="card__body">
      <p class="muted small">Errors</p>
      <p style="font-size:22px;font-weight:800;color:#dc2626;">{{ error_count | default(0) }}</p>
    </div>
  </article>
</div>

{# Filters #}
<div class="card" style="margin-bottom:16px;">
  <div class="card__body">
    <form method="get" action="{{ url_for('admin.activity_log') }}" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
      <div class="field" style="flex:1;min-width:180px;">
        <label class="label">Search</label>
        <input type="text" name="q" class="input" placeholder="IP, action, details..." value="{{ current_search }}">
      </div>
      <div class="field" style="min-width:150px;">
        <label class="label">Category</label>
        <select name="category" class="input">
          <option value="">All</option>
          {% for cat in categories %}
            <option value="{{ cat }}" {{ 'selected' if cat == current_category else '' }}>{{ cat }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field" style="min-width:120px;">
        <label class="label">Level</label>
        <select name="level" class="input">
          <option value="">All</option>
          <option value="info" {{ 'selected' if current_level == 'info' else '' }}>Info</option>
          <option value="warning" {{ 'selected' if current_level == 'warning' else '' }}>Warning</option>
          <option value="error" {{ 'selected' if current_level == 'error' else '' }}>Error</option>
        </select>
      </div>
      <button class="btn btn--primary" type="submit">Filter</button>
      <a class="btn" href="{{ url_for('admin.activity_log') }}">Clear</a>
      <a class="btn" href="{{ url_for('admin.export_activity_log') }}">Export CSV</a>
    </form>
  </div>
</div>

{# Logs table #}
<div class="card">
  <div style="overflow-x:auto;">
    <table class="admin-table" style="width:100%;border-collapse:collapse;font-size:13px;">
      <thead>
        <tr style="background:rgba(0,0,0,.03);text-align:left;">
          <th style="padding:10px 12px;font-weight:700;">Time</th>
          <th style="padding:10px 8px;">Level</th>
          <th style="padding:10px 8px;">Category</th>
          <th style="padding:10px 8px;">Action</th>
          <th style="padding:10px 8px;">User</th>
          <th style="padding:10px 8px;">IP</th>
          <th style="padding:10px 8px;">Path</th>
          <th style="padding:10px 8px;">Details</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr style="border-bottom:1px solid rgba(0,0,0,.04);{% if log.level == 'warning' %}background:rgba(245,158,11,.04);{% elif log.level == 'error' %}background:rgba(220,38,38,.04);{% endif %}">
          <td style="padding:8px 12px;white-space:nowrap;color:var(--muted);">
            {{ log.created_at.strftime('%b %d, %H:%M:%S') if log.created_at else '-' }}
          </td>
          <td style="padding:8px;">
            {% if log.level == 'warning' %}
              <span style="color:#d97706;font-weight:700;font-size:11px;text-transform:uppercase;">WARN</span>
            {% elif log.level == 'error' %}
              <span style="color:#dc2626;font-weight:700;font-size:11px;text-transform:uppercase;">ERR</span>
            {% else %}
              <span style="color:var(--muted);font-size:11px;">info</span>
            {% endif %}
          </td>
          <td style="padding:8px;">
            <span style="background:rgba(0,0,0,.05);padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">{{ log.category or '-' }}</span>
          </td>
          <td style="padding:8px;font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;">{{ log.action or '-' }}</td>
          <td style="padding:8px;">
            {% if log.user %}
              <span title="{{ log.user.email }}">{{ log.user.name or log.user.email }}</span>
            {% else %}
              <span style="color:var(--muted);">-</span>
            {% endif %}
          </td>
          <td style="padding:8px;font-family:monospace;font-size:11px;">{{ log.ip_address or '-' }}</td>
          <td style="padding:8px;max-width:160px;overflow:hidden;text-overflow:ellipsis;" title="{{ log.path or '' }}">{{ log.path or '-' }}</td>
          <td style="padding:8px;max-width:250px;overflow:hidden;text-overflow:ellipsis;color:var(--muted);" title="{{ log.details or '' }}">{{ log.details or '-' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" style="padding:24px;text-align:center;color:var(--muted);">No activity logs found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# Pagination #}
{% if pagination and pagination.pages > 1 %}
<div style="display:flex;justify-content:center;gap:6px;margin-top:16px;">
  {% if pagination.has_prev %}
    <a class="btn btn--sm" href="{{ url_for('admin.activity_log', page=pagination.prev_num, category=current_category, level=current_level, q=current_search) }}">Prev</a>
  {% endif %}
  <span class="muted small" style="padding:8px;">Page {{ pagination.page }} of {{ pagination.pages }}</span>
  {% if pagination.has_next %}
    <a class="btn btn--sm" href="{{ url_for('admin.activity_log', page=pagination.next_num, category=current_category, level=current_level, q=current_search) }}">Next</a>
  {% endif %}
</div>
{% endif %}

<div style="margin-top:16px;padding:12px;background:rgba(0,0,0,.02);border-radius:10px;">
  <p class="muted small">Activity logs are append-only and cannot be edited or deleted through the interface. All form submissions, logins, admin actions, and page views are recorded with timestamps, IP addresses, and user agents for compliance and safety. Export to CSV for record-keeping.</p>
</div>

{% endblock %}
