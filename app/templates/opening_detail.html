
{% extends "base.html" %}
{% block content %}
<style>
/* Photo grid */
.photos-grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:4px;border-radius:var(--radius);overflow:hidden;max-height:420px;margin-bottom:20px;}
.photos-grid__main{grid-row:span 2;position:relative;cursor:pointer;overflow:hidden;}
.photos-grid__thumb{position:relative;cursor:pointer;overflow:hidden;}
.photos-grid__main img,.photos-grid__thumb img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .25s;}
.photos-grid__main:hover img,.photos-grid__thumb:hover img{transform:scale(1.03);}
.photos-grid__more{position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.6);color:#fff;padding:5px 12px;border-radius:8px;font-size:12px;font-weight:600;pointer-events:none;}
@media(max-width:640px){.photos-grid{grid-template-columns:1fr;grid-template-rows:auto;max-height:none;}.photos-grid__main{grid-row:span 1;height:240px;}.photos-grid__thumb{height:160px;}}

/* Detail layout */
.detail-grid{display:grid;grid-template-columns:1fr 340px;gap:20px;}
@media(max-width:820px){.detail-grid{grid-template-columns:1fr;}}
.detail-sidebar .card{position:sticky;top:80px;}

/* Facts row */
.facts-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;}
.fact-box{background:rgba(11,95,87,.04);border-radius:14px;padding:14px;text-align:center;}
.fact-box__icon{font-size:20px;margin-bottom:2px;}
.fact-box__label{font-size:11px;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);font-weight:600;}
.fact-box__value{font-size:15px;font-weight:700;margin-top:1px;}
@media(max-width:480px){.facts-row{grid-template-columns:1fr 1fr;}}

/* Included */
.included-list{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px;}
.included-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(11,95,87,.03);border-radius:10px;font-size:14px;}
.included-item__check{color:var(--brand);font-weight:800;}
@media(max-width:480px){.included-list{grid-template-columns:1fr;}}

/* Privacy */
.privacy-box{display:flex;align-items:flex-start;gap:10px;padding:12px 14px;border-radius:12px;background:rgba(11,95,87,.04);border:1px solid rgba(11,95,87,.1);font-size:13px;color:var(--muted);line-height:1.5;margin-top:14px;}
.steps-list{margin:0 0 8px;padding-left:20px;}.steps-list li{margin:6px 0;font-size:14px;color:var(--muted);}

/* Lightbox */
.lb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.94);z-index:100;flex-direction:column;align-items:center;justify-content:center;}
.lb.open{display:flex;}
.lb__close{position:absolute;top:14px;right:18px;background:none;border:none;color:#fff;font-size:32px;cursor:pointer;opacity:.7;transition:opacity .15s;line-height:1;}
.lb__close:hover{opacity:1;}
.lb__counter{position:absolute;top:18px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.6);font-size:14px;font-weight:600;}
.lb__img{max-width:88vw;max-height:68vh;object-fit:contain;border-radius:10px;}
.lb__arrow{position:absolute;top:50%;transform:translateY(-50%);width:46px;height:46px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:#fff;font-size:22px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s;}
.lb__arrow:hover{background:rgba(255,255,255,.2);}
.lb__arrow--prev{left:16px;}
.lb__arrow--next{right:16px;}
.lb__strip{display:flex;gap:6px;margin-top:14px;overflow-x:auto;max-width:88vw;padding:2px 0;}
.lb__strip::-webkit-scrollbar{display:none;}
.lb__strip-item{flex:0 0 60px;height:42px;border-radius:6px;overflow:hidden;cursor:pointer;border:2px solid transparent;opacity:.45;transition:all .2s;}
.lb__strip-item.active{border-color:#fff;opacity:1;}
.lb__strip-item:hover{opacity:.8;}
.lb__strip-item img{width:100%;height:100%;object-fit:cover;}
</style>

<section class="section">
  <div class="container">

    <!-- Header -->
    <div class="section-head">
      <div>
        <h1>{{ opening.title }}</h1>
        <p class="muted">
          {% if opening.city %}{{ opening.city }}{% endif %}{% if opening.state %}{% if opening.city %}, {% endif %}{{ opening.state }}{% endif %}
          {% if opening.available_on %} ¬∑ Available {{ opening.available_on.strftime('%b %d, %Y') }}{% endif %}
          ¬∑ {{ opening.beds_available }} bed{{ 's' if opening.beds_available != 1 else '' }} available
        </p>
      </div>
      <div class="actions">
        <a class="btn btn--primary" href="{{ url_for('public.tour') }}">Schedule a tour</a>
        <a class="btn" href="{{ url_for('public.openings') }}">‚Üê All openings</a>
      </div>
    </div>

    <!-- Photo gallery -->
    {% set photos = opening.photos %}
    {% if photos|length > 0 %}
    <div class="photos-grid" {% if photos|length == 1 %}style="grid-template-columns:1fr;grid-template-rows:auto;max-height:420px;"{% endif %}>
      <div class="photos-grid__main" data-lb-open="0" role="button" tabindex="0" aria-label="View photo 1 of {{ photos|length }}">
        <img src="{{ photos[0] }}" alt="{{ opening.title }} ‚Äî Photo 1" loading="eager">
        {% if photos|length == 1 %}
          <div class="photos-grid__more">üì∑ 1 photo</div>
        {% endif %}
      </div>
      {% if photos|length >= 2 %}
      <div class="photos-grid__thumb" data-lb-open="1" role="button" tabindex="0" aria-label="View photo 2 of {{ photos|length }}">
        <img src="{{ photos[1] }}" alt="{{ opening.title }} ‚Äî Photo 2" loading="eager">
      </div>
      {% endif %}
      {% if photos|length >= 3 %}
      <div class="photos-grid__thumb" data-lb-open="2" role="button" tabindex="0" aria-label="View all {{ photos|length }} photos">
        <img src="{{ photos[2] }}" alt="{{ opening.title }} ‚Äî Photo 3" loading="eager">
        {% if photos|length > 3 %}
          <div class="photos-grid__more">+{{ photos|length - 3 }} more</div>
        {% endif %}
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Detail grid -->
    <div class="detail-grid">

      <!-- LEFT -->
      <div>
        <!-- Quick facts -->
        <div class="facts-row">
          <div class="fact-box">
            <div class="fact-box__icon">üõèÔ∏è</div>
            <div class="fact-box__label">Beds</div>
            <div class="fact-box__value">{{ opening.beds_available }}</div>
          </div>
          <div class="fact-box">
            <div class="fact-box__icon">üìÖ</div>
            <div class="fact-box__label">Move-in</div>
            <div class="fact-box__value">{{ opening.available_on.strftime('%b %Y') if opening.available_on else 'Flexible' }}</div>
          </div>
          <div class="fact-box">
            <div class="fact-box__icon">üè†</div>
            <div class="fact-box__label">Type</div>
            <div class="fact-box__value">Shared</div>
          </div>
          <div class="fact-box">
            <div class="fact-box__icon">üìç</div>
            <div class="fact-box__label">Area</div>
            <div class="fact-box__value">{{ opening.city or 'Central Coast' }}</div>
          </div>
        </div>

        {% if opening.summary %}
        <div class="card">
          <div class="card__body">
            <h3 class="h3">About this home</h3>
            <div class="prose">{{ opening.summary }}</div>
          </div>
        </div>
        {% endif %}

        {% if opening.details %}
        <div class="card" style="margin-top:14px;">
          <div class="card__body">
            <h3 class="h3">Details</h3>
            <div class="prose">{{ opening.details | nl2br }}</div>
          </div>
        </div>
        {% endif %}

        {% if opening.included %}
        <div class="card" style="margin-top:14px;">
          <div class="card__body">
            <h3 class="h3">What's included</h3>
            <div class="included-list">
              {% for line in opening.included.splitlines() %}
                {% if line.strip() %}
                <div class="included-item">
                  <span class="included-item__check">‚úì</span>
                  {{ line.strip() }}
                </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if opening.house_rules %}
        <div class="card" style="margin-top:14px;">
          <div class="card__body">
            <h3 class="h3">House expectations</h3>
            <div class="prose">{{ opening.house_rules | nl2br }}</div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- RIGHT SIDEBAR -->
      <div class="detail-sidebar">
        <div class="card">
          <div class="card__body">
            <h3 class="h3">Interested in this home?</h3>
            <p class="muted" style="margin:0 0 14px;">Tour first, apply when ready. No pressure.</p>

            <a class="btn btn--primary" href="{{ url_for('public.tour') }}" style="width:100%;justify-content:center;">Schedule a Tour</a>
            <a class="btn" href="{{ url_for('public.apply') }}" style="width:100%;justify-content:center;margin-top:8px;">Apply Now</a>
            <a class="btn" href="{{ url_for('public.deposit') }}" style="width:100%;justify-content:center;margin-top:8px;background:rgba(11,95,87,.06);border-color:var(--brand);color:var(--brand);">üí≥ Pay Deposit ‚Äî Lock In Your Bed</a>
            <a class="btn btn--ghost" href="{{ url_for('public.contact') }}" style="width:100%;justify-content:center;margin-top:4px;font-size:13px;color:var(--muted);">Ask a question</a>

            <div style="margin-top:16px;padding-top:14px;border-top:1px solid rgba(0,0,0,.06);">
              <h3 class="h3">Next steps</h3>
              <ol class="steps-list">
                <li>Schedule a tour or apply (2-3 min)</li>
                <li>We call/text to confirm fit</li>
                <li>We share pricing &amp; move-in details</li>
              </ol>
            </div>

            <div style="margin-top:14px;padding-top:14px;border-top:1px solid rgba(0,0,0,.06);">
              <h3 class="h3">Pricing</h3>
              {% if opening.hide_price %}
                <p class="muted" style="margin:4px 0;">Pricing is shared after a quick application so we can confirm fit and keep things fair.</p>
              {% else %}
                <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-top:6px;">
                  <div>
                    <div class="muted tiny">Monthly</div>
                    <div style="font-weight:800;font-size:1.1rem;">{{ opening.price_monthly }}</div>
                  </div>
                  {% if opening.deposit %}
                  <div>
                    <div class="muted tiny">Deposit</div>
                    <div style="font-weight:800;font-size:1.1rem;">{{ opening.deposit }}</div>
                  </div>
                  {% endif %}
                </div>
              {% endif %}
            </div>

            <div style="margin-top:14px;padding-top:14px;border-top:1px solid rgba(0,0,0,.06);">
              <h3 class="h3">Contact</h3>
              <p class="muted" style="margin:4px 0;">
                {% if opening.contact_name %}<strong>{{ opening.contact_name }}</strong><br>{% endif %}
                {% if opening.contact_email %}<a class="link" href="mailto:{{ opening.contact_email }}" style="color:var(--brand);">{{ opening.contact_email }}</a><br>{% endif %}
                {% if opening.contact_phone %}<a class="link" href="tel:{{ opening.contact_phone }}" style="color:var(--brand);">{{ opening.contact_phone }}</a>{% endif %}
                {% if not opening.contact_email and not opening.contact_phone %}
                  <a class="link" href="mailto:support@overcomersrc.com" style="color:var(--brand);">support@overcomersrc.com</a><br>
                  <a class="link" href="tel:+18052028473" style="color:var(--brand);">(805) 202-8473</a>
                {% endif %}
              </p>
            </div>

            <div class="privacy-box">
              <span style="font-size:16px;flex-shrink:0;">üîí</span>
              <div>For resident safety, the exact address is shared only after a tour or application.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="card__body">
        <p class="muted">Questions? <a href="{{ url_for('public.contact') }}" class="link" style="color:var(--brand);">Contact us</a> or read the <a href="{{ url_for('public.guide') }}" class="link" style="color:var(--brand);">resident guide</a>.</p>
      </div>
    </div>

  </div>
</section>

<!-- Lightbox -->
{% if photos|length > 0 %}
<div class="lb" id="lb" role="dialog" aria-label="Photo gallery">
  <button class="lb__close" id="lbClose" aria-label="Close gallery">‚úï</button>
  <div class="lb__counter" id="lbCount"></div>
  <button class="lb__arrow lb__arrow--prev" id="lbPrev" aria-label="Previous photo">‚Äπ</button>
  <button class="lb__arrow lb__arrow--next" id="lbNext" aria-label="Next photo">‚Ä∫</button>
  <div class="lb__imgWrap" id="lbImgWrap" style="display:flex;align-items:center;justify-content:center;min-height:40vh;">
    <img class="lb__img" id="lbImg" src="" alt="">
    <div class="lb__loader" id="lbLoader" style="display:none;color:rgba(255,255,255,.5);font-size:14px;">Loading‚Ä¶</div>
  </div>
  <div class="lb__strip" id="lbStrip"></div>
</div>

<script>
(function() {
  'use strict';

  /* ‚îÄ‚îÄ Safe JSON parse of photos array ‚îÄ‚îÄ */
  var photos;
  try {
    photos = {{ photos | tojson }};
  } catch(e) {
    photos = [];
  }
  if (!Array.isArray(photos)) photos = [];
  // Filter out any empty/invalid entries
  photos = photos.filter(function(u) { return u && typeof u === 'string' && u.trim().length > 0; });
  if (photos.length === 0) return;

  var idx = 0;
  var total = photos.length;
  var lb = document.getElementById('lb');
  var lbImg = document.getElementById('lbImg');
  var lbCount = document.getElementById('lbCount');
  var lbStrip = document.getElementById('lbStrip');
  var lbLoader = document.getElementById('lbLoader');
  var lbImgWrap = document.getElementById('lbImgWrap');
  var isOpen = false;

  if (!lb || !lbImg || !lbCount || !lbStrip) return;  // Guard against missing DOM

  // Preload first 3 images
  photos.slice(0, 3).forEach(function(url) {
    var img = new Image();
    img.src = url;
  });

  function openLB(i) {
    if (typeof i !== 'number' || isNaN(i)) i = 0;
    idx = Math.max(0, Math.min(i, total - 1));
    render();
    lb.classList.add('open');
    document.body.style.overflow = 'hidden';
    isOpen = true;
  }

  function closeLB() {
    lb.classList.remove('open');
    document.body.style.overflow = '';
    isOpen = false;
  }

  function navLB(d) {
    idx = (idx + d + total) % total;
    render();
  }

  function goLB(i) {
    if (typeof i !== 'number' || isNaN(i)) return;
    idx = Math.max(0, Math.min(i, total - 1));
    render();
  }

  function render() {
    try {
      if (lbLoader) { lbLoader.style.display = 'block'; lbLoader.textContent = 'Loading‚Ä¶'; }
      lbImg.style.opacity = '0.3';

      var img = new Image();
      img.onload = function() {
        lbImg.src = photos[idx];
        lbImg.alt = 'Photo ' + (idx + 1) + ' of ' + total;
        lbImg.style.opacity = '1';
        if (lbLoader) lbLoader.style.display = 'none';
        // Preload next and previous
        if (total > 1) {
          new Image().src = photos[(idx + 1) % total];
          new Image().src = photos[(idx - 1 + total) % total];
        }
      };
      img.onerror = function() {
        lbImg.src = '';
        lbImg.alt = 'Photo unavailable';
        lbImg.style.opacity = '1';
        if (lbLoader) { lbLoader.textContent = 'Photo unavailable'; lbLoader.style.display = 'block'; }
      };
      img.src = photos[idx];

      lbCount.textContent = (idx + 1) + ' / ' + total;

      // Thumbnail strip
      var html = '';
      for (var i = 0; i < total; i++) {
        html += '<div class="lb__strip-item' + (i === idx ? ' active' : '') + '" data-lb-thumb="' + i + '">';
        html += '<img src="' + photos[i] + '" alt="Photo ' + (i + 1) + '" loading="lazy">';
        html += '</div>';
      }
      lbStrip.innerHTML = html;

      // Scroll active thumb into view
      var activeThumb = lbStrip.querySelector('.active');
      if (activeThumb) activeThumb.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
    } catch(err) {
      console.error('Lightbox render error:', err);
    }
  }

  /* ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ */

  // Grid photo clicks ‚Üí open lightbox
  document.querySelectorAll('[data-lb-open]').forEach(function(el) {
    el.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      var i = parseInt(this.getAttribute('data-lb-open'), 10);
      openLB(i);
    });
    // Also allow Enter key for accessibility
    el.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        var i = parseInt(this.getAttribute('data-lb-open'), 10);
        openLB(i);
      }
    });
  });

  // Lightbox close button
  document.getElementById('lbClose').addEventListener('click', function(e) { e.stopPropagation(); closeLB(); });

  // Previous / Next arrows
  document.getElementById('lbPrev').addEventListener('click', function(e) { e.stopPropagation(); navLB(-1); });
  document.getElementById('lbNext').addEventListener('click', function(e) { e.stopPropagation(); navLB(1); });

  // Thumbnail strip click delegation
  lbStrip.addEventListener('click', function(e) {
    var target = e.target.closest('[data-lb-thumb]');
    if (target) {
      e.stopPropagation();
      goLB(parseInt(target.getAttribute('data-lb-thumb'), 10));
    }
  });

  // Click backdrop to close (NOT the image, arrows, or strip)
  lb.addEventListener('click', function(e) {
    if (e.target === lb || e.target === lbImgWrap) closeLB();
  });

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (!isOpen) return;
    if (e.key === 'ArrowLeft' || e.key === 'a') { e.preventDefault(); navLB(-1); }
    else if (e.key === 'ArrowRight' || e.key === 'd') { e.preventDefault(); navLB(1); }
    else if (e.key === 'Escape') closeLB();
  });

  // Touch swipe support (mobile)
  var sx = 0, sy = 0;
  lb.addEventListener('touchstart', function(e) {
    sx = e.touches[0].clientX;
    sy = e.touches[0].clientY;
  }, {passive: true});
  lb.addEventListener('touchend', function(e) {
    var dx = sx - e.changedTouches[0].clientX;
    var dy = Math.abs(sy - e.changedTouches[0].clientY);
    if (Math.abs(dx) > 40 && dy < 80) navLB(dx > 0 ? 1 : -1);
  }, {passive: true});

  // Expose globally for any fallback needs
  window.openLB = openLB;
  window.closeLB = closeLB;
  window.navLB = navLB;
  window.goLB = goLB;
})();
</script>
{% endif %}

{% endblock %}
